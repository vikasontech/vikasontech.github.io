<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Vikas Blogs - JPA EntityListner example with Spring Boot 1.5.1 </title>

    
    
    <meta content="ApplicationContext, Audit, JPA, Simple Spring Program, Spring, Spring Boot" name="keywords">
    
    <meta content="Vikas Blogs - To audit any transaction table you can use EntityListener Annotation of the JPA. JPA provide the EntityListener annotations that attach a listener class with the entity that you want to audit." name="description">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    

    

    

    
    
    <script type="text/javascript" async
        src="/mathjax-3.0.0/tex-mml-chtml.js">
    </script>
    

    <link rel="stylesheet" href="/layui/css/layui.css">
    <link rel="stylesheet" href="/self/css/default.css">
    <script src="/layui/layui.js"></script>


    <link rel="stylesheet" async href="/self/css/markdown.min.css">
    <link rel="stylesheet" async href="/self/css/gallery.css">
    <link rel="stylesheet" async href="/font-awesome-4.7.0/css/font-awesome.min.css">
    <script src="/self/js/lazysizes.min.js" async></script></head>

<body>
    
    <header class="layui-header layui-bg-cyan">

    
        <a href=""><img src="/self/img/avater.jpg" class="layui-nav-img" style="margin-left:10px;margin-top:-10px"></a>
    
    
    <a class="nav-self-logo" href="/">
        Vikas Blogs
    </a>

    <ul class="layui-nav layui-layout-right layui-bg-cyan" lay-filter="">
        
        
        <li class="layui-nav-item" id="nav_big"><a href="/post/">Posts</a></li>
        

        

        
        <li class="layui-nav-item" id="nav_small">
            <a href="javascript:;">
                <i class="layui-icon layui-icon-app" style="font-size: 24px;"></i>
            </a>

            <dl class="layui-nav-child">
                
                <dd><a href="/post/">Posts</a></dd>
                

                
            </dl>
        </li>
    </ul>
</header>

<script>
layui.use('element', function(){
  var element = layui.element;
});
</script>
        <div id="content" style="min-height:80%">
<div class="layui-container" style="margin-bottom: 10px">
    

    <div class="layui-row layui-col-space10">
        <div class="layui-col-md12 layui-col-sm12 layui-col-xs12">
            <div class="layui-card single-card">
                <br />
                <blockquote class="layui-elem-quote markdown-body single-title" >
                    <h1>JPA EntityListner example with Spring Boot 1.5.1</h1>
                    <h3 style="margin-top:10px; margin-bottom:10px"> 
    <i class="layui-icon layui-icon-date" style="font-size: 24px; vertical-align: -2px;"></i>
    <span>2017-04-25</span>

    
    <i class="layui-icon layui-icon-tabs" style="font-size: 22px; vertical-align: 0px;"></i>
    
        <a href="/tags/applicationcontext/">
            <span class="layui-badge" style="vertical-align: 2px;">ApplicationContext</span>
        </a>
    
        <a href="/tags/audit/">
            <span class="layui-badge" style="vertical-align: 2px;">Audit</span>
        </a>
    
        <a href="/tags/jpa/">
            <span class="layui-badge" style="vertical-align: 2px;">JPA</span>
        </a>
    
        <a href="/tags/simple-spring-program/">
            <span class="layui-badge" style="vertical-align: 2px;">Simple Spring Program</span>
        </a>
    
        <a href="/tags/spring/">
            <span class="layui-badge" style="vertical-align: 2px;">Spring</span>
        </a>
    
        <a href="/tags/spring-boot/">
            <span class="layui-badge" style="vertical-align: 2px;">Spring Boot</span>
        </a>
    
</h3>
                </blockquote>
                <div class="layui-card-body markdown-body single-content">
                    <p><em><strong>Introduction</strong></em></p>
<p>To audit any transaction table you can use EntityListener Annotation of the JPA. JPA provide the EntityListener annotations that attach a listener class with the entity that you want to audit.</p>
<p><strong>What is audit table ?</strong></p>
<p>Audit Tables are used to track transactions against a particular table or tables. They allow you to see an ongoing &ldquo;log&rdquo; for future use.</p>
<p>There may be users and/or applications that have access to insert, update, and delete out of that table. If you may want to have a quick and easy way to track who is doing what on that table.</p>
<p><strong>Scope</strong></p>
<p>We will create a trigger like functionality. We shall audit all the DML operations (i.e. Insert, update and delete) on a table. We shall log all details of the operation, time-stamp, and the user name details in the audit log table.</p>
<p><em><strong>Dependencies</strong></em></p>
<p><strong>Create Application</strong></p>
<p>First create User Entity class that contain the user details data.</p>
<p><strong>User.java</strong></p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/922f7609cc40fa747e388eb88345ccf8.js"></script>

<p>Create Spring data repository to create CRUD operations on the database.</p>
<p><strong>UserRepository.java</strong>
<script type="application/javascript" src="https://gist.github.com/vikasontech/fd79aa27ba8c3d9216728bc0fa6abe50.js"></script>
</p>
<p>Create a Controller class to handle the Request -</p>
<p>UserController.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/9374bd993dbc9c5aa026c0a8650bc669.js"></script>

<p>Create Application class for spring boot configuration.</p>
<p>Application.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/5fbc12a1f11df5640827344b4d35f256.js"></script>

<p>Project Structure -</p>
<p><img src="https://1.bp.blogspot.com/-FUS9PNR1kGg/WQAJkM41WsI/AAAAAAAAb8c/-cYowNtOJ68GGqpP5BkkuiqSR2ZWWZQxwCLcB/s400/Project_Structure.png" alt="Project Structure"></p>
<p>Compile the application with below maven command -</p>
<p><code>mvn clean install</code></p>
<p>Run the example by below command on the command line  -</p>
<p><code>mvn spring-boot:run</code></p>
<p>You can now perform create and update operation on the user entity.</p>
<p><strong>Create AuditLog Entity and AuditLogRepository class</strong></p>
<p>Create a AuditLog entity for audit log table, to keep the audit data -</p>
<p>AuditLog.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/f93c9bc12e89f44ee8cce15d2ac6ea0f.js"></script>

<p>Create a Spring repository for CRUD operation on the on database.</p>
<p>AuditLogRepository.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/a13a816638ddbf6cb1b7654a4dc966ae.js"></script>

<p><strong>Attach AuditLog entity with User Entity class</strong></p>
<p>First create a Entity Listener class that will listen the User table, and if any update operation performed on the User entity, the listener will call the call back methods.</p>
<p>UserAuditLogListener.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/eee81e198a67e2cb35feee5b9021d8d2.js"></script>

<p>The same callback method or entity listener method can be annotated with more than one callback annotation. For a given entity, you cannot have two methods being annotated by the same callback annotation whether it is a callback method or an entity listener method. A callback method is a no-arg method with no return type and any arbitrary name. An entity listener has the signature void <!-- raw HTML omitted -->(Object) where Object is of the actual entity type (note that Hibernate Entity Manager relaxed this constraint and allows Object of java.lang.Object type (allowing sharing of listeners across several entities.)</p>
<p>A callback method can raise a RuntimeException. The current transaction, if any, must be rolled back.</p>
<p>The following callbacks can be used -</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>@PrePersist</td>
<td>Executed before the entity manager persist operation is actually executed or cascaded. This call is synchronous with the persist operation.</td>
</tr>
<tr>
<td>@PreRemove</td>
<td>Executed before the entity manager remove operation is actually executed or cascaded. This call is synchronous with the remove operation.</td>
</tr>
<tr>
<td>@PostPersist</td>
<td>Executed after the entity manager persist operation is actually executed or cascaded. This call is invoked after the database INSERT is executed.</td>
</tr>
<tr>
<td>@PostRemove</td>
<td>Executed after the entity manager remove operation is actually executed or cascaded. This call is synchronous with the remove operation.</td>
</tr>
<tr>
<td>@PreUpdate</td>
<td>Executed before the database UPDATE operation.</td>
</tr>
<tr>
<td>@PostUpdate</td>
<td>Executed after the database UPDATE operation.</td>
</tr>
<tr>
<td>@PostLoad</td>
<td>Executed after an entity has been loaded into the current persistence context or an entity has been refreshed.</td>
</tr>
</tbody>
</table>
<p>For more information please refer <a href="https://docs.jboss.org/hibernate/entitymanager/3.5/reference/en/html/listeners.html" target="_blank">this link</a>.</p>
<p>Thing to keep in mind!!
You can define several entity listeners per entity at different level of the hierarchy. You can also define several callbacks at different level of the hierarchy. But you cannot define two listeners for the same event in the same entity or the same entity listener.</p>
<p>When an event is raised, the listeners are executed in this order:
@EntityListeners for a given entity or super class in the array order
Entity listeners for the super classes (highest first)
Entity Listeners for the entity
Callbacks of the super classes (highest first)
Callbacks of the entity</p>
<p><strong>Modify User entity to attach EntityListener class</strong></p>
<p>User.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/1e790079cfd1913241dc395edec9ed23.js"></script>

<p>Annotation <code>@EntityListners</code> specifies the callback listener classes to be used for an entity or mapped super class.<code>@EntityListeners (value = UserAuditLogListener.class)</code> will attach the <code>UserAuditLogListener.class</code> with the User Entity class.</p>
<p>JPA Entitylisteners are not entities, they are simply java classes in which JPA life cycle callback methods are implemented using annotations.</p>
<p><strong>Save data in the AuditLog table</strong></p>
<p>To inject <code>AuditLogRepository</code> into the <code>UserAuditLogListener</code> we can use an <code>ApplicationContextAware</code> Bean that will give the <code>AuditRepository</code> from Spirng context  to save the Audit data. So, Create a <code>BeanUtility</code> service that implement the application context.</p>
<p>BeanUtility.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/1d2638c22c13b57d0ac3225894edf40b.js"></script>

<p>Create a controller class to handle the request for audit log data .</p>
<p>AuditorController.java</p>
<script type="application/javascript" src="https://gist.github.com/vikasontech/e5a6b14131619d263b47dd1164385a02.js"></script>

<p><em><strong>Updated Project Structure</strong></em></p>
<p><img src="https://1.bp.blogspot.com/-NHgKrrA4Mms/WQAcL7PsukI/AAAAAAAAb8s/NanCf5f7XUsiy7rUWcE5ODMqBQsn1j-hgCLcB/s400/Project_Structure_2.png" alt="updated project structure"></p>
<p>Now build the program using below maven command on the command line  -</p>
<p><code>mvn clean install</code></p>
<p>Run the example by below command on the command line  -</p>
<p><code>mvn spring-boot:run</code></p>
<p>You can download the sample code from below link -
<a href="https://github.com/vikasontech/springjapauditlog" target="_blank">Sample Program</a></p>
</div>
            </div>
        </div>

        
    </div>
</div>


        </div><footer>
    

    <div class="layui-container">
        <div class="layui-row">
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs6">
              
            </div>
        </div>
        <div class="layui-row">
            
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs12">
                <a href="/"><p class="footer-url">home</p></a>
            </div>
            
            <div class="layui-col-md4 layui-col-sm6 layui-col-xs12">
                <a href="/about/"><p class="footer-url">About</p></a>
            </div>
            
        </div>
    </div>
    
    
    <div class="layui-container">
        <p class="copyright">Copyright © 2019–2020, Vikas Verma</p>
    </div>
</footer>

</body>
</html>
